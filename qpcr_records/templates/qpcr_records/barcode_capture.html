{% extends 'qpcr_records/base.html' %} {% block content %} {% load crispy_forms_tags %}

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<div class="jumbotron jumbotron-fluid mb-0 py-5">
    <!-- Header Information -->
    <div class="container">
        <div class="row">
            <h2 class="display-4">Input Sample Plate</h2>
            <div class="col-md-8 px-0">
                <!-- Instruction card -->
                <div class="mb-3 mr-3">
                    <div class="card">
                        <div class="card-header"><h4>Instructions</h4></div>
                        <div class="card-body">
                            {% if form.ssp_well.value != 'A1' and form.ssp_well.value != 'H1'%}
                            <p>Scan sample barcode and load sample into the indicated well below</p>
                            {% else %}
                            <p>Load control sample into the indicated well below</p>
                            {% endif %}
                            <h5>Current Well: <b><code>{{well}}</code></b></h5>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-row">
                    <div id="platemap" class="col-8 px-0"></div>

                <!-- Platemap Legend Information -->
                    <div class="col-4">
                    <div class="card">
                        <div class="card-header"><h4>Plate Legend</h4></div>
                        <ul id="legend" class="list-group">
                            <li class="list-group-item d-flex flex-row">
                                <div class="well"></div>
                                <span class="px-3 my-auto">Sample</span>
                            </li>
                            <li class="list-group-item d-flex flex-row">
                                <div class="well control-well"></div>
                                <span class="px-3 my-auto">Control</span>
                            </li>
                            <li class="list-group-item d-flex flex-row">
                                <div class="well active-well"></div>
                                <span class="px-3 my-auto">Current Sample</span>
                            </li>
                            <li class="list-group-item d-flex flex-row">
                                <div class="well loaded-well"></div>
                                <span class="px-3 my-auto">Loaded Samples</span>
                            </li>
                        </ul>
                    </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4 px-0">
                <!-- Previously Scanned Barcode List -->
                <div class="card">
                    <h4 class="card-header">
                        Previously Scanned Barcodes
                    </h4>
                    <div class="overflow-auto" style="max-height: 300px;">
                    <table class="table table-hover table-bordered overflow-auto border-top-0 mb-0">
                        <thead>
                            <tr>
                            <th scope="col">Well</th>
                            <th scope="col">Barcode</th>
                            </tr>
                        </thead>
                        <tbody id="scanned-barcodes">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Input Sample Barcode Information -->
<div class="container">
    <form class="needs-validation my-3" action="/qpcr_records/barcode_capture/" method="GET" novalidate>
        {% csrf_token %}
        <div class="form-row">
            <!-- Load controls step: hide barcode field -->
            {% if form.ssp_well.value != 'A1' and form.ssp_well.value != 'H1' %}
            <div>
                {{ form.barcode|as_crispy_field }}
            </div>
            {% endif %}
            <div>
                {{ form.ssp_well|as_crispy_field }}
            </div>
            <div>
                {{ form.sep_well|as_crispy_field }}
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Proceed To Next Well</button>
    </form>
    <hr>
    <form class="my-3" action="/qpcr_records/scan_plate_1_2_barcode/" method="GET">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('Are you sure?')" class="btn btn-primary">End Plate</button>
    </form>
</div>

<script>

    // TODO retrieve platemap size
    var rowNames = ["A", "B", "C", "D", "E", "F", "G", "H"]
    var colNames = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

    // Determine well size and padding as factor of parent size
    function getWellSize() {
        var plate = document.getElementById("platemap");
        var size = (plate.offsetWidth / colNames.length);
        return size;
    }

    // Create plate elements
    function renderPlate() {
        var plate = document.getElementById("platemap");
        var activeWell = "{{ form.ssp_well.value|safe }}";

        var wellSize = getWellSize();

        // Create grid of wells
        colNames.forEach(col => {
            // create column
            var plateCol = document.createElement("div");
            plateCol.id = "col" + col;
            plateCol.classList.add("plate-col");
            if (col == activeWell[1]) {
                plateCol.classList.add("active-col");
            }
            // Create wells in column
            rowNames.forEach(row => {

                var well = document.createElement("div");

                // Well ID e.g. A1, D9, etc.
                label = row + col;
                well.id = label;
                labeldiv = document.createElement("div");
                labeldiv.innerText = label;
                well.appendChild(labeldiv);

                // Set square width/height size
                well.classList.add("well");


                if (label == 'A1' | label == 'H1') {
                    well.classList.add("control-well");
                }
                var activeRow = activeWell[0];
                var activeCol = activeWell.substring(1);

                for (const loadedWell in {{ barcodes|safe }}) {
                    $("#"+loadedWell).addClass("loaded-well");
                }

                if (label == activeWell) {
                    well.classList.add("active-well");
                    well.classList.add("active");
                }
                plateCol.appendChild(well);
            });
            plate.append(plateCol);
        });

        resizePlate();
    }

    // Update well size and padding based on window resize
    function resizePlate() {
        var plate = document.getElementById("platemap");
        var wellSize = getWellSize();

        var cols = document.querySelectorAll('.plate-col');
        cols.forEach(c => {
            c.style.marginLeft = wellSize / 10 - .1 + "px";
            c.style.marginRight = wellSize / 10 - .1 + "px";
        });

        var wells = document.querySelectorAll('.well');
        wells.forEach(w => {
            w.style.width = (8 * wellSize / 10) + "px";
            w.style.height = (8 * wellSize / 10) + "px";
            w.style.marginTop = (2 * wellSize / 10) + "px";
            w.style.marginBottom = (2 * wellSize / 10) + "px";
        });

    }

    function renderScannedBarcodes() {
        $scannedBarcodes = $("#scanned-barcodes");

        var barcodes = {{ barcodes|safe }};
        for (const well in barcodes) {
            console.log(well);
            var $well = $('<th>').attr('scope', 'row')
                                        .text(well);
            var $barcode = $('<td>').text(barcodes[well]);
            var $row = $('<tr>');
            $row.append($well);
            $row.append($barcode);
            $scannedBarcodes.prepend($row);
        }
    }

    function validateBarcodeForm() {
        var activeWell = "{{ form.ssp_well.value|safe }}";
        if (activeWell == 'A1' || activeWell == 'H1')
            return;

        var well2barcode = {{ barcodes|safe }};
        var barcodes = [];
        for (const loadedWell in well2barcode) {
            barcodes.push(well2barcode[loadedWell]);
        }

        validateForm({{ form.barcode.id_for_label }}, function() {
            // return false if barcode already exists
            var value = {{ form.barcode.id_for_label }}.value.trim();
            console.log(barcodes);
            console.log(value);
            return !barcodes.includes(value);
        }, "Barcode already exists!");
    };

    // Add window event hooks
    window.addEventListener("load", () => {
        renderPlate();
        renderScannedBarcodes();
        validateBarcodeForm();
    });
    window.addEventListener("resize", resizePlate);
</script>
<style>
    .scroll {
        max-height: 538px;
        overflow-y: auto;
    }
    #platemap {
        background: lightblue;
        border-radius: 4px;
    }

    .plate-col {
        display: inline-block;
    }

    .well {
        background: white;
        /* border: 1px solid darkgrey; */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .well div {
        color: darkgrey;
    }

    .active-col .well {
        border: 1px solid black;
    }

    .active-col .well div {
        color: black;
    }

    .active-well {
        background: yellow;
        font-weight: bold;
    }

    .loaded-well {
        background: grey;
        color: white;
    }

    .control-well {
        background: lightcoral !important;
        font-weight: normal;
    }

    .control-well div {
        color: white;
    }

    #legend .well {
        border: 1px solid grey;
        margin: 0 !important;
    }

    #legend span {
        margin: auto 0;
    }
</style>
{% endblock %}
